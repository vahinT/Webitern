<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webitern | Red Glass Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Vibe */
        body {
            background-color: #0f0505;
            background-image: 
                radial-gradient(circle at 20% 30%, #450a0a 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, #7f1d1d 0%, transparent 40%);
            color: #fee2e2;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        /* Scrollbar Rizz */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(20, 0, 0, 0.5);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(239, 68, 68, 0.6);
        }

        /* Glassmorphism Class */
        .glass-panel {
            background: rgba(40, 10, 10, 0.25);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 100, 100, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .glass-btn {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(153, 27, 27, 0.2));
            border: 1px solid rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
        }
        .glass-btn:hover {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.4), rgba(153, 27, 27, 0.4));
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
            transform: translateY(-1px);
        }

        /* Syntax Highlighting Mockup */
        .code-editor {
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.5;
            tab-size: 4;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #ef4444;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            width: 300px;
            padding: 20px;
            border-radius: 12px;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row p-4 gap-4">

    <!-- Sidebar / Settings -->
    <aside class="glass-panel w-full md:w-1/4 rounded-2xl p-6 flex flex-col gap-6 overflow-y-auto">
        <div class="flex items-center gap-3 mb-2">
            <!-- Logo removed as requested -->
            <div>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-red-600">Webitern</h1>
                <p class="text-xs text-red-200 opacity-70">Red Glass Edition</p>
            </div>
        </div>

        <!-- AI Generator -->
        <div class="space-y-4 pt-2">
            <h2 class="text-sm uppercase tracking-widest text-red-400 font-semibold">AI Chef üë®‚Äçüç≥</h2>
            <textarea id="aiPrompt" rows="4" class="glass-input w-full rounded-lg p-2 text-sm" placeholder="Describe the website you want (e.g. 'A portfolio with a neon red theme')..."></textarea>
            <button onclick="generateWithAI()" id="aiBtn" class="glass-btn w-full rounded-lg p-3 text-sm font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Cook it up
            </button>
        </div>

        <!-- Git Actions -->
        <div class="mt-auto space-y-3 pt-4 border-t border-red-900">
            <h2 class="text-sm uppercase tracking-widest text-red-400 font-semibold">Deployment</h2>
            <p class="text-[10px] text-gray-400">Target: github.com/Webitern</p>
            <input type="text" id="repoName" class="glass-input w-full rounded-lg p-2" placeholder="Repo Name (e.g. my-site)">
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="fetchRepo()" class="glass-btn rounded-lg p-2 text-xs flex flex-col items-center gap-1">
                    <i class="fa-solid fa-download"></i> Edit/Fetch
                </button>
                <button onclick="deployToGit()" id="deployBtn" class="glass-btn rounded-lg p-2 text-xs flex flex-col items-center gap-1">
                    <i class="fa-brands fa-github"></i> Deploy
                </button>
            </div>
            <div id="statusLog" class="text-xs font-mono text-red-200 h-32 overflow-y-auto p-2 glass-input rounded-lg">
                <span class="opacity-50">> System Ready...</span>
            </div>
        </div>
    </aside>

    <!-- Main Editor Area -->
    <main class="glass-panel w-full md:w-3/4 rounded-2xl flex flex-col overflow-hidden relative">
        
        <!-- Tabs Header -->
        <div class="flex items-center bg-black/20 p-2 overflow-x-auto" id="fileTabs">
            <!-- Tabs injected via JS -->
            <button class="bg-red-600/20 text-red-200 px-4 py-1 rounded-t-lg mr-1 text-sm border-b-2 border-red-500">index.html</button>
        </div>
        
        <!-- Toolbar -->
        <div class="flex items-center justify-between px-4 py-2 border-b border-red-900/30 bg-black/10">
            <div class="flex gap-2">
                <!-- Trigger hidden file input -->
                <button onclick="document.getElementById('fileUpload').click()" class="text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded text-red-200 transition" title="Upload Files">
                    <i class="fa-solid fa-folder-open"></i> Upload / Add
                </button>
                <!-- Hidden Input -->
                <input type="file" id="fileUpload" class="hidden" multiple onchange="handleFileUpload(this)">

                <button onclick="createBlankFile()" class="text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded text-red-200 transition" title="New Blank File">
                    <i class="fa-solid fa-plus"></i> Create
                </button>

                <button onclick="deleteCurrentFile()" class="text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded text-red-200 transition">
                    <i class="fa-solid fa-trash"></i> Delete
                </button>
            </div>
            <button onclick="updatePreview()" class="text-xs bg-green-900/30 hover:bg-green-800/50 px-3 py-1 rounded text-green-200 border border-green-800/50 transition flex items-center gap-2">
                <i class="fa-solid fa-play"></i> Run Preview
            </button>
        </div>

        <!-- Editor & Preview Split -->
        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <!-- Code Editor -->
            <div class="flex-1 relative group">
                <textarea id="mainEditor" class="w-full h-full bg-transparent p-4 text-sm text-gray-300 code-editor resize-none focus:outline-none" spellcheck="false" oninput="saveCurrentFile()"></textarea>
            </div>

            <!-- Preview Iframe -->
            <div class="h-1/2 lg:h-full lg:w-1/2 border-t lg:border-t-0 lg:border-l border-red-900/30 bg-white relative">
                <iframe id="previewFrame" class="w-full h-full border-none"></iframe>
                <div class="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur">Preview</div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. State Management ---
        let files = {
            'index.html': '<!-- Welcome to Webitern -->\n<h1 style="color:red; font-family:sans-serif;">Hello World</h1>\n<p>AI Generated site will appear here.</p>',
            'style.css': 'body { background: #111; color: white; }',
            'script.js': 'console.log("Webitern initialized");'
        };
        let currentFile = 'index.html';

        // --- 2. Obfuscated Keys ---
        const _O_GIT = "3deW12pPY85ZcYO3j9v9kW79XjzvG0PJlPc_phg"; 
        const _O_GEM = "EWJvWZs2XCz22hZR9kuunvumpU-pt9eDySaziA";

        function getGitToken() { return _O_GIT.split('').reverse().join(''); }
        function getGeminiKey() { return _O_GEM.split('').reverse().join(''); }

        window.onload = () => {
            renderTabs();
            loadEditor();
            updatePreview();
        };

        // --- 3. UI Logic ---
        function log(msg, type='info') {
            const logDiv = document.getElementById('statusLog');
            const entry = document.createElement('div');
            entry.className = `mb-1 ${type === 'error' ? 'text-red-500 font-bold' : 'text-red-200'}`;
            entry.innerHTML = `> ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function renderTabs() {
            const container = document.getElementById('fileTabs');
            container.innerHTML = '';
            Object.keys(files).forEach(filename => {
                const btn = document.createElement('button');
                const isActive = filename === currentFile;
                btn.className = `px-4 py-1 rounded-t-lg mr-1 text-sm border-b-2 transition whitespace-nowrap
                    ${isActive 
                        ? 'bg-red-600/20 text-white border-red-500' 
                        : 'bg-transparent text-gray-400 border-transparent hover:bg-white/5'}`;
                btn.textContent = filename;
                btn.onclick = () => switchFile(filename);
                container.appendChild(btn);
            });
        }

        function switchFile(filename) {
            files[currentFile] = document.getElementById('mainEditor').value; // Save current
            currentFile = filename;
            loadEditor();
            renderTabs();
        }

        function loadEditor() {
            document.getElementById('mainEditor').value = files[currentFile] || '';
        }

        function saveCurrentFile() {
            files[currentFile] = document.getElementById('mainEditor').value;
        }

        function createBlankFile() {
            const name = prompt("Enter new file name (e.g., page.html):");
            if (name) {
                if (files[name]) {
                    alert("File already exists!");
                } else {
                    files[name] = "";
                    switchFile(name);
                    log(`Created ${name}`);
                }
            }
        }

        function handleFileUpload(input) {
            const uploadedFiles = input.files;
            if (uploadedFiles.length === 0) return;

            Array.from(uploadedFiles).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Overwrite if exists, or create new
                    files[file.name] = e.target.result;
                    log(`Uploaded ${file.name}`);
                    // Refresh tabs after last one
                    if (file === uploadedFiles[uploadedFiles.length - 1]) {
                        renderTabs();
                        switchFile(file.name);
                    }
                };
                reader.readAsText(file); // Assuming text files for web dev
            });
            input.value = ''; // Reset
        }

        function deleteCurrentFile() {
            if(Object.keys(files).length <= 1) return alert("Can't delete the last file!");
            if(confirm(`Delete ${currentFile}?`)) {
                delete files[currentFile];
                currentFile = Object.keys(files)[0];
                renderTabs();
                loadEditor();
            }
        }

        // --- 4. Preview Logic ---
        function updatePreview() {
            let htmlContent = files['index.html'] || "<h1>No index.html found</h1>";
            const cssContent = files['style.css'] || "";
            const jsContent = files['script.js'] || "";

            // Simple injection for preview
            if (!htmlContent.includes('<style>')) {
                htmlContent = htmlContent.replace('</head>', `<style>${cssContent}</style></head>`);
            }
            if (!htmlContent.includes('<script>')) {
                htmlContent = htmlContent.replace('</body>', `<script>${jsContent}<\/script></body>`);
            }
            
            const frame = document.getElementById('previewFrame');
            frame.srcdoc = htmlContent;
        }

        // --- 5. AI Generation (Gemini) ---
        async function generateWithAI() {
            const prompt = document.getElementById('aiPrompt').value;
            const btn = document.getElementById('aiBtn');
            const key = getGeminiKey();

            if (!prompt) return alert("Enter a prompt!");

            btn.innerHTML = '<div class="spinner"></div> Cooking...';
            btn.disabled = true;
            log("Calling Gemini Chef...", "info");

            const sysPrompt = `You are a web generator. 
            RETURN ONLY JSON. 
            Format: { "files": [ {"name": "index.html", "content": "..."}, {"name": "style.css", "content": "..."} ] }. 
            Create a modern website based on the user request. 
            Use inline CSS/JS or separate files as needed but output must be the JSON structure.
            Do not include markdown backticks.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: sysPrompt + "\nUser Request: " + prompt }]
                        }]
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const cleanJson = text.replace(/```json/g, '').replace(/```/g, '');
                const parsed = JSON.parse(cleanJson);

                if (parsed.files) {
                    parsed.files.forEach(f => {
                        files[f.name] = f.content;
                    });
                    renderTabs();
                    if(files['index.html']) switchFile('index.html');
                    else switchFile(Object.keys(files)[0]);
                    updatePreview();
                    log("‚ú® Website served successfully!");
                }
            } catch (e) {
                console.error(e);
                log("Failed to cook: " + e.message, "error");
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Cook it up';
                btn.disabled = false;
            }
        }

        // --- 6. GitHub Integration ---
        const GH_USER = "Webitern"; // Hardcoded config

        async function fetchRepo() {
            const repo = document.getElementById('repoName').value;
            const token = getGitToken();

            if(!repo) return alert("Need repo name!");

            log(`Fetching ${GH_USER}/${repo}...`);
            
            try {
                const res = await fetch(`https://api.github.com/repos/${GH_USER}/${repo}/contents`, {
                    headers: { 'Authorization': `token ${token}` }
                });

                if(!res.ok) throw new Error(await res.text());
                const data = await res.json();

                files = {}; 
                for (const item of data) {
                    if (item.type === 'file' && (item.name.endsWith('.html') || item.name.endsWith('.css') || item.name.endsWith('.js'))) {
                        const fileRes = await fetch(item.download_url);
                        files[item.name] = await fileRes.text();
                        log(`Loaded ${item.name}`);
                    }
                }
                
                if(Object.keys(files).length === 0) {
                    files['index.html'] = "<!-- Empty Repo -->";
                }

                renderTabs();
                switchFile(Object.keys(files)[0]);
                updatePreview();
                log(`Repo loaded! Edit URL: https://github.com/${GH_USER}/${repo}`);

            } catch(e) {
                log("Fetch failed: " + e.message, "error");
            }
        }

        async function deployToGit() {
            const repo = document.getElementById('repoName').value;
            const token = getGitToken();
            const btn = document.getElementById('deployBtn');

            if(!repo) return alert("Enter repo name!");

            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            log("Starting deployment...");

            try {
                // 1. Create Repo (if not exists)
                let res = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        name: repo, 
                        private: false,
                        auto_init: true 
                    })
                });

                if (res.status === 201) log("‚úÖ Repo created.");
                else if (res.status === 422) log("‚ÑπÔ∏è Repo exists, updating...");
                else if (!res.ok) throw new Error("Repo creation failed: " + res.status);

                // 2. Push Files
                for (const [filename, content] of Object.entries(files)) {
                    log(`Pushing ${filename}...`);
                    
                    let sha = null;
                    try {
                        const check = await fetch(`https://api.github.com/repos/${GH_USER}/${repo}/contents/${filename}`, {
                            headers: { 'Authorization': `token ${token}` }
                        });
                        if (check.ok) {
                            const checkJson = await check.json();
                            sha = checkJson.sha;
                        }
                    } catch(e) {}

                    const pushRes = await fetch(`https://api.github.com/repos/${GH_USER}/${repo}/contents/${filename}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}` },
                        body: JSON.stringify({
                            message: `Update ${filename} via Webitern`,
                            content: btoa(unescape(encodeURIComponent(content))),
                            sha: sha
                        })
                    });
                    
                    if(!pushRes.ok) log(`‚ùå Failed to push ${filename}`, "error");
                }

                // 3. Enable Pages
                log("Enabling GitHub Pages...");
                const pagesRes = await fetch(`https://api.github.com/repos/${GH_USER}/${repo}/pages`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.switcheroo-preview+json'
                    },
                    body: JSON.stringify({ source: { branch: 'main', path: '/' } })
                });

                const repoUrl = `https://github.com/${GH_USER}/${repo}`;
                
                if(pagesRes.ok || pagesRes.status === 409) {
                    const pageUrl = `https://${GH_USER}.github.io/${repo}/`;
                    log(`üéâ DEPLOYED!`);
                    log(`Repo: <a href="${repoUrl}" target="_blank" class="underline text-white">${repoUrl}</a>`);
                    log(`Site: <a href="${pageUrl}" target="_blank" class="underline text-white">${pageUrl}</a>`);
                } else {
                    log("‚ö†Ô∏è Pages check failed (might already be on).", "info");
                    log(`Repo: <a href="${repoUrl}" target="_blank" class="underline text-white">${repoUrl}</a>`);
                }

            } catch (e) {
                log("Deploy Error: " + e.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-brands fa-github"></i> Deploy';
            }
        }
    </script>
</body>
</html>
